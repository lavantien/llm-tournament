<!doctype html>
<html>
  <head>
    <title>Results</title>
    <link rel="stylesheet" href="/templates/style.css" />
    <script>
      function updateResult(model, promptIndex, pass, checkbox) {
        var loadingIndicator = document.createElement("span");
        loadingIndicator.className = "loading";
        checkbox.parentNode.appendChild(loadingIndicator);
        checkbox.style.display = "none";

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/update_result", true);
        xhr.setRequestHeader(
          "Content-type",
          "application/x-www-form-urlencoded",
        );
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4 && xhr.status == 200) {
            checkbox.style.display = "";
            loadingIndicator.remove();
            updateScore(model);
            updateCheckmark(checkbox, pass);
          }
        };
        var params =
          "model=" +
          encodeURIComponent(model) +
          "&promptIndex=" +
          promptIndex +
          "&pass=" +
          pass;
        xhr.send(params);
      }

      function updateScore(model) {
        var totalScoreCell = document.querySelector('tr:has(td:first-child:contains("' + model + '")) td:last-child');
        if (totalScoreCell) {
          var checkboxes = document.querySelectorAll('tr:has(td:first-child:contains("' + model + '")) input[type="checkbox"]');
          var score = 0;
          checkboxes.forEach(function(checkbox) {
            if (checkbox.checked) {
              score++;
            }
          });
          totalScoreCell.innerHTML = score + '<div class="progress-bar-container"><div class="progress-bar" style="width: ' + (score / checkboxes.length * 100) + '%;"></div></div>';
        }
      }

      function updateCheckmark(checkbox, pass) {
        var passSpan = checkbox.parentNode.querySelector('.pass');
        var failSpan = checkbox.parentNode.querySelector('.fail');
        if (pass) {
          if (passSpan) {
            passSpan.style.display = 'inline';
          } else {
            checkbox.parentNode.innerHTML += '<span class="pass">&#10004;</span>';
          }
          if (failSpan) {
            failSpan.style.display = 'none';
          }
        } else {
          if (failSpan) {
            failSpan.style.display = 'inline';
          } else {
            checkbox.parentNode.innerHTML += '<span class="fail">&#10008;</span>';
          }
          if (passSpan) {
            passSpan.style.display = 'none';
          }
        }
      }
    </script>
  </head>

  <body>
    {{template "nav"}}
    <div class="sticky-header">
      <h2>Add Model</h2>
      <form
        action="/add_model"
        method="post"
        style="display: flex; align-items: center"
      >
        <input
          type="text"
          name="model"
          placeholder="Enter new model name"
          style="margin-right: 10px"
        />
        <input type="submit" value="Add" />
      </form>
    </div>
    <h1>Results</h1>
    <form action="/results" method="get">
      <label for="model_filter">Filter by Model:</label>
      <select name="model_filter" id="model_filter">
        <option value="">All Models</option>
        {{range $model := .Models}}
        <option value="{{$model}}">{{$model}}</option>
        {{end}}
      </select>
      <input type="submit" value="Filter" />
    </form>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Model</th>
          {{range $index, $prompt := .PromptIndices}}
          <th>Prompt {{$prompt}}</th>
          {{end}}
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {{$i := 0}} {{range $model, $results := .Results}} {{if or (eq
        $.ModelFilter "") (eq $.ModelFilter $model)}}
        <tr>
          <td>{{$i = inc $i}}{{$i}}</td>
          <td>{{$model}}</td>
          {{range $index, $pass := $results}}
          <td>
            <input
              type="checkbox"
              {{if
              $pass}}checked{{end}}
              onchange="updateResult('{{$model}}', {{$index}}, this.checked, this)"
            />
            {{if $pass}}<span class="pass">&#10004;</span>{{else}}<span
              class="fail"
              >&#10008;</span
            >{{end}}
          </td>
          {{end}}
          <td>
            {{index $.TotalScores $model}}
            <div class="progress-bar-container">
              <div
                class="progress-bar"
                style="width: {{index $.PassPercentages $model}}%;"
              ></div>
            </div>
          </td>
        </tr>
        {{end}} {{end}}
      </tbody>
    </table>
    <div class="sticky-footer">
      <h2>Manage Results</h2>
      <div style="display: flex; align-items: center">
        <form action="/reset_results" method="post" style="margin-right: 10px">
          <input type="submit" value="Reset Results" />
        </form>
        <form action="/export_results" method="post" style="margin-right: 10px">
          <input type="submit" value="Export Results" />
        </form>
        <form
          action="/import_results"
          method="post"
          enctype="multipart/form-data"
          style="display: flex; align-items: center"
        >
          <input type="file" name="results_file" style="margin-right: 10px" />
          <input type="submit" value="Import Results" />
        </form>
      </div>
    </div>
  </body>
</html>
