<!doctype html>
<html data-theme="coffee">
  <head>
    <title>Prompt List</title>
    <link rel="stylesheet" href="/templates/output.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
  </head>

  <body>
    <div class="flex flex-col min-h-screen bg-base-200 p-3">
      {{template "nav" .}}
      <main class="flex-1 flex flex-col gap-3 overflow-auto">
    <div class="card bg-base-100 shadow-lg p-4 m-0 sticky-header flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 flex-shrink-0">
        <h2 class="text-sm tracking-wide text-base-content/88">Add Prompt</h2>
        <input
          type="checkbox"
          id="select-all-prompts"
          class="ml-2.5 checkbox"
        />
        <label for="select-all-prompts" class="ml-2 label-text text-base-content/64">Select All</label>
        <span id="selected-count" class="ml-2 label-text text-base-content/64">(0 selected)</span>
      </div>
      <form
        action="/add_prompt"
        method="post"
        class="flex items-center gap-2 flex-1 justify-center"
      >
        <textarea
          name="prompt"
          placeholder="Enter new prompt"
          class="textarea textarea-bordered w-64 min-w-[280px] h-20 resize-y"
          aria-label="Enter new prompt"
        ></textarea>
        <textarea
          name="solution"
          placeholder="Enter solution"
          class="textarea textarea-bordered w-64 min-w-[280px] h-20 resize-y"
          aria-label="Enter solution"
        ></textarea>
        <select name="profile" class="select select-bordered" aria-label="Select profile">
          <option value="">None</option>
          {{range .Profiles}}
          <option value="{{.Name}}">{{.Name}}</option>
          {{end}}
        </select>
        <input type="submit" value="Add" class="btn btn-primary" />
      </form>
      <div class="flex items-center gap-2 flex-shrink-0">
        <form
          action="/update_prompts_order"
          method="post"
        >
          <input type="hidden" name="order" id="prompts-order-input" value="" />
          <input type="submit" value="Save Order" class="btn btn-primary" title="Save the current order of prompts" />
        </form>
        <a
          id="bulk-delete-button"
          class="btn btn-error"
        >Bulk Delete</a>
      </div>
    </div>
    <div class="card bg-base-100 shadow-lg p-4 m-0 title-row flex items-center gap-3">
      <form action="/prompts" method="get" class="flex items-center gap-2 flex-shrink-0">
        <select name="order_filter" id="order_filter" class="select select-bordered" aria-label="Filter by order">
          <option value="">All Orders</option>
          {{range $index := .PromptIndices}}
          <option value="{{$index}}">{{$index}}</option>
          {{end}}
        </select>
        <select name="profile_filter" id="profile_filter" class="select select-bordered" aria-label="Filter by profile">
          <option value="">All Profiles</option>
          {{range .Profiles}}
          <option value="{{.Name}}">{{.Name}}</option>
          {{end}}
        </select>
        <input type="submit" value="Filter" class="btn btn-primary" />
      </form>
      <h1 class="text-base tracking-wide flex-shrink-0">Prompts</h1>
      <form action="/prompts" method="get" class="search-form flex items-center gap-2 flex-1">
        <input
          type="text"
          name="search_query"
          id="search_query"
          value="{{.SearchQuery}}"
          placeholder="Search prompts..."
          class="input input-bordered w-80 max-w-full"
          aria-label="Search prompts"
        />
        <input type="submit" value="Search" class="btn btn-primary" />
      </form>
    </div>
    <ul id="prompt-list" class="flex flex-col gap-3">
      {{if .Prompts}} {{range $index, $prompt := .Prompts}} {{if and (or (eq
      $.OrderFilter 0) (eq $.OrderFilter (inc $index))) (or (eq $.ProfileFilter
      "") (eq $prompt.Profile $.ProfileFilter)) (or (eq $.SearchQuery "")
      (contains (tolower $prompt.Text) (tolower $.SearchQuery)))}}
      <li draggable="true" data-index="{{$index}}" class="card bg-base-100 shadow-lg p-3 m-0">
        <div class="flex items-center justify-between w-full gap-3">
          <input
            type="checkbox"
            class="prompt-checkbox checkbox"
            data-index="{{$index}}"
          />
          <h3 class="flex-shrink-0 mr-2.5 text-sm font-semibold">
            {{inc $index}}.{{if
            $prompt.Profile}}&nbsp;<span class="badge badge-success badge-outline badge-sm">{{$prompt.Profile}}</span>{{end}}
          </h3>
          <div class="markdown-content flex-1 mr-2.5 text-sm">
            {{$prompt.Text | markdown}}
          </div>
          <div
            class="flex-shrink-0 w-1/5 italic text-left text-success markdown-content text-sm"
          >
            {{$prompt.Solution | markdown}}
          </div>
          <div class="prompt-actions flex-shrink-0 flex gap-1.5 ml-2.5">
            <button
              class="btn btn-ghost btn-sm"
              onclick="copyPrompt('{{$prompt.Text}}')"
              title="Copy prompt to clipboard"
              aria-label="Copy prompt"
            >
              üìã
            </button>
            <a
              class="btn btn-ghost btn-sm"
              href="/edit_prompt?index={{$index}}"
              title="Edit this prompt"
              aria-label="Edit prompt"
            >‚úèÔ∏è</a
            >
            <a
              class="btn btn-ghost btn-sm"
              href="/delete_prompt?index={{$index}}"
              title="Delete this prompt"
              aria-label="Delete prompt"
            >üóëÔ∏è</a
            >
            <a
              class="btn btn-ghost btn-sm"
              href="/move_prompt?index={{$index}}"
              title="Move this prompt"
              aria-label="Move prompt"
            >üîÄ</a
            >
          </div>
        </div>
      </li>
      {{end}} {{end}} {{else}}
      <p class="text-center text-base-content/64">No prompts available.</p>
      {{end}}
    </ul>
    <div class="card bg-base-100 shadow-lg p-4 m-0 sticky-footer flex items-center gap-3">
      <h2 class="text-sm tracking-wide text-base-content/88 flex-shrink-0">Manage Prompts</h2>
      <form action="/reset_prompts" method="get">
        <input type="submit" value="Reset Prompts" class="btn btn-primary" />
      </form>
      <form action="/export_prompts" method="post">
        <input type="submit" value="Export Prompts" class="btn btn-primary" />
      </form>
      <form
        action="/import_prompts"
        method="post"
        enctype="multipart/form-data"
        class="flex items-center gap-2"
      >
        <input type="file" name="prompts_file" class="file-input file-input-bordered" aria-label="Select prompts file to import" />
        <input type="submit" value="Import Prompts" class="btn btn-primary" />
      </form>
    </div>
    <script>
      function copyPrompt(text) {
        navigator.clipboard.writeText(text).then(
          function () {
            console.log("Async: Copying to clipboard was successful!");
          },
          function (err) {
            console.error("Async: Could not copy text: ", err);
          },
        );
      }

      function updateOrder() {
        const items = promptList.querySelectorAll("li");
        const order = Array.from(items).map((item) =>
          parseInt(item.getAttribute("data-index")),
        );
        document.getElementById("prompts-order-input").value =
          JSON.stringify(order);
        const searchQuery = document.getElementById("search_query").value;
        const url = new URL(window.location.href);
        url.searchParams.set("search_query", searchQuery);
        window.history.replaceState({}, "", url.toString());
      }

      const promptList = document.getElementById("prompt-list");
      let draggedItem = null;

      promptList.addEventListener("dragstart", (e) => {
        draggedItem = e.target;
        e.dataTransfer.setData("text/plain", "");
      });

      promptList.addEventListener("dragover", (e) => {
        e.preventDefault();
      });

      promptList.addEventListener("drop", (e) => {
        e.preventDefault();
        if (e.target.tagName === "LI" && e.target !== draggedItem) {
          const dropTarget = e.target;
          const parent = dropTarget.parentNode;
          const draggedIndex = parseInt(draggedItem.getAttribute("data-index"));
          const dropIndex = parseInt(dropTarget.getAttribute("data-index"));

          if (draggedIndex < dropIndex) {
            parent.insertBefore(draggedItem, dropTarget.nextSibling);
          } else {
            parent.insertBefore(draggedItem, dropTarget);
          }
          updateOrder();
        }
      });

      window.onload = () => {
        updateOrder();
        setupBulkDelete();
      };
      function updateBulkDeleteButton() {
        const selectAllCheckbox = document.getElementById("select-all-prompts");
        const promptCheckboxes = document.querySelectorAll(".prompt-checkbox");
        const bulkDeleteButton = document.getElementById("bulk-delete-button");
        const selectedIndices = Array.from(promptCheckboxes)
          .filter((checkbox) => checkbox.checked)
          .map((checkbox) => parseInt(checkbox.getAttribute("data-index")));
        if (selectedIndices.length > 0) {
          bulkDeleteButton.href = `/bulk_delete_prompts?indices=${JSON.stringify(selectedIndices)}`;
        } else {
          bulkDeleteButton.removeAttribute("href");
        }
      }

      function setupBulkDelete() {
        const selectAllCheckbox = document.getElementById("select-all-prompts");
        const promptCheckboxes = document.querySelectorAll(".prompt-checkbox");
        const bulkDeleteButton = document.getElementById("bulk-delete-button");
        const selectedCountSpan = document.getElementById("selected-count");
        let selectedCount = 0;

        function updateSelectedCount() {
          selectedCountSpan.textContent = `(${selectedCount} selected)`;
        }

        selectAllCheckbox.addEventListener("change", function () {
          promptCheckboxes.forEach((checkbox) => {
            checkbox.checked = this.checked;
          });
          selectedCount = this.checked ? promptCheckboxes.length : 0;
          updateSelectedCount();
          updateBulkDeleteButton();
        });

        promptCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            if (this.checked) {
              selectedCount++;
            } else {
              selectedCount--;
            }
            updateSelectedCount();
            updateBulkDeleteButton();
          });
        });

        updateBulkDeleteButton();

        function bulkDeletePrompts(indices) {
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/bulk_delete_prompts", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.onload = function () {
            if (xhr.status === 200) {
              console.log("Prompts deleted successfully");
              window.location.reload();
            } else {
              console.error("Error deleting prompts:", xhr.statusText);
            }
          };
          xhr.onerror = function () {
            console.error("Error deleting prompts");
          };
          xhr.send(JSON.stringify({ indices: indices }));
        }
      }
    </script>
    <div class="fixed left-4 bottom-4 flex flex-col gap-2 z-[1000]">
      <button class="btn btn-info" onclick="scrollToTop()">‚Üë</button>
      <button class="btn btn-info" onclick="scrollToBottom()">‚Üì</button>
    </div>
    <script>
      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function scrollToBottom() {
        const footerHeight =
          document.querySelector(".sticky-footer").offsetHeight;
        const scrollHeight =
          document.body.scrollHeight - window.innerHeight - footerHeight;
        window.scrollTo({
          top: scrollHeight,
          behavior: "smooth",
        });
      }
    </script>
    <div class="hidden">
      <span id="prompts-data">{{.Prompts | json}}</span>
    </div>
      </main>
    </div>
  </body>
</html>
