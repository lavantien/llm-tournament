<!doctype html>
<html data-theme="coffee">

<head>
    <title>Evaluate</title>
    <link rel="stylesheet" href="/templates/output.css" />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <script src="/templates/score-utils.js"></script>
</head>

<body>
    <div class="flex flex-col min-h-screen bg-base-200 p-3">
        {{template "nav" .}}
        <main class="flex-1 flex flex-col gap-3 overflow-auto">
            <div class="card bg-base-100 shadow-lg p-4">
        <h2 class="text-center text-xl font-bold">{{.Model}}</h2>
        <h3 class="text-center text-base font-medium">Prompt {{inc (atoi .PromptIndex)}} of {{.TotalPrompts}}</h3>

        <form action="/evaluate?model={{.Model}}&prompt={{.PromptIndex}}" method="post">
            <input type="hidden" name="score" id="selectedScore" value="{{.CurrentScore}}">

            <div class="flex flex-wrap gap-2 justify-center py-4">
                {{range $label, $value := .ScoreOptions}}
                {{if eq $value 0}}
                <button type="button" class="w-12 h-12 flex items-center justify-center font-bold rounded-lg shadow-sm cursor-pointer hover:opacity-80 transition-opacity"
                        style="background-color: #808080; color: white;"
                        onclick="selectScoreButton('{{$value}}')"
                        data-score="{{$value}}">
                    {{$label}}
                </button>
                {{end}}
                {{if eq $value 20}}
                <button type="button" class="w-12 h-12 flex items-center justify-center font-bold rounded-lg shadow-sm cursor-pointer hover:opacity-80 transition-opacity"
                        style="background-color: #ffa500; color: white;"
                        onclick="selectScoreButton('{{$value}}')"
                        data-score="{{$value}}">
                    {{$label}}
                </button>
                {{end}}
                {{if eq $value 40}}
                <button type="button" class="w-12 h-12 flex items-center justify-center font-bold rounded-lg shadow-sm cursor-pointer hover:opacity-80 transition-opacity"
                        style="background-color: #ffd700; color: white;"
                        onclick="selectScoreButton('{{$value}}')"
                        data-score="{{$value}}">
                    {{$label}}
                </button>
                {{end}}
                {{if eq $value 60}}
                <button type="button" class="w-12 h-12 flex items-center justify-center font-bold rounded-lg shadow-sm cursor-pointer hover:opacity-80 transition-opacity"
                        style="background-color: #00bfff; color: white;"
                        onclick="selectScoreButton('{{$value}}')"
                        data-score="{{$value}}">
                    {{$label}}
                </button>
                {{end}}
                {{if eq $value 80}}
                <button type="button" class="w-12 h-12 flex items-center justify-center font-bold rounded-lg shadow-sm cursor-pointer hover:opacity-80 transition-opacity"
                        style="background-color: #a77bff; color: white;"
                        onclick="selectScoreButton('{{$value}}')"
                        data-score="{{$value}}">
                    {{$label}}
                </button>
                {{end}}
                {{if eq $value 100}}
                <button type="button" class="w-12 h-12 flex items-center justify-center font-bold rounded-lg shadow-sm cursor-pointer hover:opacity-80 transition-opacity"
                        style="background-color: #7cff6b; color: white;"
                        onclick="selectScoreButton('{{$value}}')"
                        data-score="{{$value}}">
                    {{$label}}
                </button>
                {{end}}
                {{end}}
            </div>

            <div class="flex items-center justify-center gap-2 py-4">
                <a href="/evaluate?model={{.Model}}&prompt={{if gt (atoi .PromptIndex) 0}}{{sub (atoi .PromptIndex) 1}}{{else}}{{.PromptIndex}}{{end}}" class="btn btn-info" {{if eq (atoi .PromptIndex) 0}}style="visibility: hidden;"{{end}}>‚¨ÖÔ∏è</a>
                <a href="/evaluate?model={{.Model}}&prompt={{if lt (atoi .PromptIndex) (sub .TotalPrompts 1)}}{{add (atoi .PromptIndex) 1}}{{else}}{{.PromptIndex}}{{end}}" class="btn btn-info" {{if eq (atoi .PromptIndex) (sub .TotalPrompts 1)}}style="visibility: hidden;"{{end}}>‚û°Ô∏è</a>
                <span>_</span>
                <button type="button" class="btn btn-primary" onclick="copyPromptText()">üìã</button>
                <span>_</span>
                <button type="submit" class="btn btn-success">‚úÖ</button>
                <a href="/results" class="btn btn-error">‚ùå</a>
            </div>
        </form>

        <div class="card bg-base-200 shadow-md p-4 my-4">
          <h4 class="font-semibold mb-2">Prompt:</h4>
          <div class="markdown-content">{{.PromptText}}</div>
      </div>
      <hr class="divider"/>
      <div class="card bg-base-200 shadow-md p-4 my-4">
          <h4 class="font-semibold mb-2">Solution:</h4>
          <div class="markdown-content">{{.Solution}}</div>
      </div>
      <hr class="divider"/>
      <div class="card bg-base-200 shadow-md p-4 my-4">
          <h4 class="font-semibold mb-2">Model Response:</h4>
          <textarea id="modelResponse" rows="10" placeholder="Model's response will appear here..." class="textarea textarea-bordered w-full">{{.ModelResponse}}</textarea>
          <div class="mt-2">
              <button type="button" class="btn btn-primary" onclick="saveModelResponse()">üíæ Save Response</button>
              <span id="save-status"></span>
          </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/templates/score-utils.js"></script>
    <script>
      let rawPromptMarkdown = '';
      let rawSolutionMarkdown = '';
      
      function selectScoreButton(score) {
        document.getElementById('selectedScore').value = score;
        document.querySelectorAll('[data-score]').forEach(b => b.style.border = 'none');
        document.querySelector(`button[data-score="${score}"]`).style.border = '4px solid white';
      }
      
      document.addEventListener('DOMContentLoaded', function() {
        const promptMarkdownElement = document.querySelector('.markdown-content:first-of-type');
        const solutionMarkdownElement = document.querySelector('.markdown-content:nth-of-type(2)');
        
        rawPromptMarkdown = promptMarkdownElement.textContent;
        rawSolutionMarkdown = solutionMarkdownElement.textContent;
        
        const markdownElements = document.querySelectorAll('.markdown-content');
        markdownElements.forEach(function(el) {
          el.innerHTML = marked.parse(el.textContent);
        });
        
        const currentScore = document.getElementById('selectedScore').value;
        const currentButton = document.querySelector(
          `button[data-score="${currentScore}"]`,
        );
        if (currentButton) {
          currentButton.style.border = '4px solid white';
        }
      });
      
      function copyPromptText() {
        navigator.clipboard.writeText(rawPromptMarkdown)
          .then(() => {
            const copyButton = document.querySelector('button[onclick="copyPromptText()"]');
            const originalText = copyButton.textContent;
            copyButton.textContent = 'Copied!';
            
            setTimeout(() => {
              copyButton.textContent = "üìã";
            }, 2000);
          })
          .catch(err => {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy text. Please try again.');
          });
      }
      
      function saveModelResponse() {
        const responseText = document.getElementById('modelResponse').value;
        const statusSpan = document.getElementById('save-status');
        
        statusSpan.textContent = 'Saving...';
        
        fetch('/save_model_response', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model_id: {{.ModelID}},
            prompt_id: {{.PromptID}},
            response_text: responseText,
          }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            statusSpan.textContent = 'Saved!';
            setTimeout(() => statusSpan.textContent = '', 2000);
          } else {
            statusSpan.textContent = 'Error: ' + (data.message || 'Unknown error');
          }
        })
        .catch(error => {
          console.error('Error saving response:', error);
          statusSpan.textContent = 'Error: Failed to save';
        });
      }
    </script>
</main>
</div>
</body>

</html>
